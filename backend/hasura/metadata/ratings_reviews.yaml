---
# Hasura metadata for ratings and reviews (migration 003)

- type: pg_track_table
  args:
    schema: public
    name: user_ratings

- type: pg_track_table
  args:
    schema: public
    name: rating_helpful_votes

# Relationships - user_ratings
- type: pg_create_object_relationship
  args:
    table: user_ratings
    name: family
    using:
      foreign_key_constraint_on: family_id

- type: pg_create_object_relationship
  args:
    table: user_ratings
    name: user
    using:
      foreign_key_constraint_on: user_id

- type: pg_create_object_relationship
  args:
    table: user_ratings
    name: media_item
    using:
      foreign_key_constraint_on: media_item_id

- type: pg_create_array_relationship
  args:
    table: user_ratings
    name: helpful_votes
    using:
      foreign_key_constraint_on:
        table: rating_helpful_votes
        column: rating_id

# Relationships - rating_helpful_votes
- type: pg_create_object_relationship
  args:
    table: rating_helpful_votes
    name: rating
    using:
      foreign_key_constraint_on: rating_id

- type: pg_create_object_relationship
  args:
    table: rating_helpful_votes
    name: user
    using:
      foreign_key_constraint_on: user_id

# Permissions - user_ratings (users can rate media in their family)
- type: pg_create_select_permission
  args:
    table: user_ratings
    role: user
    permission:
      columns: '*'
      filter:
        family_id:
          _eq: X-Hasura-Family-Id

- type: pg_create_insert_permission
  args:
    table: user_ratings
    role: user
    permission:
      check:
        _and:
          - user_id:
              _eq: X-Hasura-User-Id
          - family_id:
              _eq: X-Hasura-Family-Id
      columns:
        - family_id
        - media_item_id
        - rating
        - review
        - review_title
        - contains_spoilers

- type: pg_create_update_permission
  args:
    table: user_ratings
    role: user
    permission:
      columns:
        - rating
        - review
        - review_title
        - contains_spoilers
      filter:
        user_id:
          _eq: X-Hasura-User-Id

- type: pg_create_delete_permission
  args:
    table: user_ratings
    role: user
    permission:
      filter:
        user_id:
          _eq: X-Hasura-User-Id

# Permissions - rating_helpful_votes
- type: pg_create_select_permission
  args:
    table: rating_helpful_votes
    role: user
    permission:
      columns: '*'
      filter: {}

- type: pg_create_insert_permission
  args:
    table: rating_helpful_votes
    role: user
    permission:
      check:
        user_id:
          _eq: X-Hasura-User-Id
      columns:
        - rating_id
        - is_helpful

- type: pg_create_update_permission
  args:
    table: rating_helpful_votes
    role: user
    permission:
      columns:
        - is_helpful
      filter:
        user_id:
          _eq: X-Hasura-User-Id

- type: pg_create_delete_permission
  args:
    table: rating_helpful_votes
    role: user
    permission:
      filter:
        user_id:
          _eq: X-Hasura-User-Id
